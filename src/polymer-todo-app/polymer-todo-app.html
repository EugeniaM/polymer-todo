<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app-script.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth-script.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-database-script.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../polymer-todo-authorization/todo-authorization.html">

<dom-module id="polymer-todo-app">
  <template>
    <style>
      :host {
        display: block;
        font-family: roboto, arial, sans-serif;
      }
    </style>

    <firebase-app
      auth-domain="[[config.authDomain]]"
      database-url="[[config.databaseURL]]"
      api-key="[[config.apiKey]]">
    </firebase-app>

    <firebase-auth
      id="auth"
      user="{{user}}"
      signed-in="{{signedIn}}">
    </firebase-auth>

    <app-location route="{{route}}"></app-location>

    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>
    <app-route
      route="{{subroute}}"
      pattern="/:page"
      data="{{subrouteData}}">
    </app-route>

    <iron-pages
      attr-for-selected="view"
      selected="[[routeData.page]]">
      <todo-authorization 
        view="authorization" 
        page="{{subrouteData.page}}"
        on-do-redirect="onRedirect">
      </todo-authorization>
      <div view="">22222222</div>
    </iron-pages>

  </template>

  <script>

    const config = {
        apiKey: "AIzaSyDqryvdzHi210ZEwjC4_ueq5j1L-aaKnVQ",
        authDomain: "polymer-todo-75258.firebaseapp.com",
        databaseURL: "https://polymer-todo-75258.firebaseio.com"
    }

    class PolymerTodoApp extends Polymer.Element {
      static get is() { return 'polymer-todo-app'; }
      static get properties() {
        return {
          config: {
            type: Object,
            readOnly: true,
            value() { return config; }
          },
          user: {
            type: Object,
            notify: true,
            value: false
          },
          signedIn: {
            type: Boolean,
            value: false
          },
          auth: {
            type: String,
            value: ""
          },
          route: {
            type: Object,
            value() { return {}; }
          },
          routeData: {
            type: Object,
            value() { return {}; },
            observer: "_onRouteChange"
          }
        };
      }

      static get listeners() {

      }

      ready() {
        super.ready();
        if (!this.signedIn) {
          this.set('routeData.page', 'authorization');
        }

        this.addEventListener('redirect', () => {
          console.log('REDIRECT!');

        })

        // console.log('ROUTE ===> ', this.route);
        // console.log('DATA ===> ', this.data);
        // console.log('SUBROUTE ===> ', this.subroute);
        // console.log('PAGE ===> ', this.page);
      }

      _onRouteChange(routeData) {
        if (!this.signedIn) {
          this.set('routeData.page', 'authorization');
        }
      }

      onRedirect() {
        this.set('route.path', "/")
      }
    }

    window.customElements.define(PolymerTodoApp.is, PolymerTodoApp);
  </script>
</dom-module>
